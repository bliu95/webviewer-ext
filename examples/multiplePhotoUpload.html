<!doctype html>
<meta http-equiv="cache-control" content="no-cache" />
<html>
  <head>
    <script
      src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"
      type="text/javascript"
    ></script>
  </head>
  <body>
    <input id="input" type="file" multiple="multiple" accept="image/jpeg, image/png, image/jpg" style="display: none;"> 
    <button onclick="document.getElementById('input').click();"> Upload</button>
  </body>
</html>
  
<script type="module">
  let imagesArray = [];
  let uploadedPhotos = {};
  let url, formData, apiKey;
  
  const input = document.getElementById("input");

  input.addEventListener("change", () => {
    const files = input.files
    for (let i = 0; i < files.length; i++) {
      imagesArray.push(files[i])
    }
    sendtoCloudinary();
  })
  
  async function sendtoCloudinary(){
    for (const image of imagesArray) {
      formData.set('file', image);

      const config = {
            method: 'POST',
            body: formData,
      };

      const result = await fetch(url, config);
      const json = await result.json();

      if (result.status === 200) {
        uploadedPhotos[json.original_filename] = json.url;
      }
      else {
        console.log(json.error.message);
        return;
      }
    }
    
    ThunkableWebviewerExtension.postMessage(
      JSON.stringify({type: "files", files: uploadedPhotos})
    );

    uploadedPhotos = {};
  }

  function setKey(cloudName, apiKey, preset) {
    url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
    formData = new FormData();

    formData.append('api_key', apiKey);
    formData.append("upload_preset", preset);
  }

  ThunkableWebviewerExtension.receiveMessage(function (message, callback) {
    if(message.type === 'op-window-direct-response' || message.type === 'op-window-direct-request') {
      return;
    }

    try{
      const msgFromApp = JSON.parse(message);

      if(msgFromApp.type === 'setKey') {
        setKey(msgFromApp.cloudName, msgFromApp.apiKey, msgFromApp.preset);
      }

    }
    catch (e) {
      console.error(e);
      console.error(
        "An error occurred. Message probably wasn't valid JSON string"
      );
    }
  });

  ThunkableWebviewerExtension.postMessage(
    JSON.stringify({ type: "page loaded" })
  );
</script>